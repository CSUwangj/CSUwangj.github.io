<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
	<title>LuckyDog | CSUwangj&#x27;s Blog - proxy</title>
	<link href="https://CSUwangj.github.io/tags/proxy/atom.xml" rel="self" type="application/atom+xml"/>
  <link href="https://CSUwangj.github.io/"/>
	<generator uri="https://www.getzola.org/">Zola</generator>
	<updated>2022-08-28T03:57:23+08:00</updated>
	<id>https://CSUwangj.github.io/tags/proxy/atom.xml</id>
	<entry xml:lang="en">
		<title>How I deploy Calibre-Web and tweak it</title>
		<published>2022-08-19T01:22:08+08:00</published>
		<updated>2022-08-28T03:57:23+08:00</updated>
		<link rel="alternate" href="https://CSUwangj.github.io/how-i-deploy-calibre-web-and-tweak-it/" type="text/html"/>
		<id>https://CSUwangj.github.io/how-i-deploy-calibre-web-and-tweak-it/</id>
		<content type="html">&lt;h1 id=&quot;tl-dr&quot;&gt;TL;DR&lt;&#x2F;h1&gt;
&lt;p&gt;I managed to host a calibre-web with self signed certificate at non-standard port, and let it fetch metadata through proxy(fuck GFW).&lt;&#x2F;p&gt;
&lt;p&gt;And I found a solution to bulk upload my eBooks onto it.&lt;&#x2F;p&gt;
&lt;span id=&quot;continue-reading&quot;&gt;&lt;&#x2F;span&gt;&lt;h1 id=&quot;originate-from-an-ip&quot;&gt;Originate from an IP&lt;&#x2F;h1&gt;
&lt;p&gt;After moving place and settling down, I managed to have a publicly accessable IP. When you have a server, you want an IP. When you have an IP, you want a domain. When you have a domain, wow, you have all the great things on the internet in your pocket(if your server can be that small as a NUC).&lt;&#x2F;p&gt;
&lt;p&gt;So I began to find services that can be deployed on my server through an &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;awesome-selfhosted&#x2F;awesome-selfhosted#document-management---e-books&quot;&gt;awesome-list&lt;&#x2F;a&gt;. I want a document management server that can:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;access through web&lt;&#x2F;li&gt;
&lt;li&gt;can fetch metadata by ISBN&lt;&#x2F;li&gt;
&lt;li&gt;(best to have) user authentication&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;And that&#x27;s where I found calibre-web.&lt;&#x2F;p&gt;
&lt;p&gt;I used calibre before, and it&#x27;s worked perfectly as a desktop software, but it&#x27;s built-in server just sucks. Maybe my word is too mean, it works as a just adequate E-book reader.&lt;&#x2F;p&gt;
&lt;p&gt;Calibre-web has user management so I can share books with my friends, and I can also get their collections. Calibre supports multiple formats for a book, so I can put source code on it. I can&#x27;t find a reason stop me choosing it.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;let-s-deploy-it&quot;&gt;Let&#x27;s deploy it&lt;&#x2F;h1&gt;
&lt;p&gt;I love docker, and thankfully Calibre-web come with a &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;linuxserver&#x2F;docker-calibre-web&quot;&gt;docker image&lt;&#x2F;a&gt; built by LinuxServer.io team, and that&#x27;s where nightmare comes.&lt;&#x2F;p&gt;
&lt;p&gt;This docker image download and install most of its dependencies during build phase, in one &lt;code&gt;RUN&lt;&#x2F;code&gt; command, which should be a good practice because it can reduce redundant docker image layers.&lt;&#x2F;p&gt;
&lt;p&gt;But I&#x27;m in China, we got a Great Fire Wall to pass. Dependencies can fail for no reason at any download process, curl&#x2F;apt&#x2F;pip&#x2F;etc. So I rewrite the Dockerfile, separate every download process into one &lt;code&gt;RUN&lt;&#x2F;code&gt; command, and build it several times.&lt;&#x2F;p&gt;
&lt;p&gt;Image ready, all I need to do is run and see the success log... At least that&#x27;s what I thought.&lt;&#x2F;p&gt;
&lt;p&gt;For users who want to perform book conversion, they should run docker image with an extra environment variable &lt;code&gt;DOCKER_MODS=linuxserver&#x2F;mods:universal-calibre&lt;&#x2F;code&gt;, which will download it from internet, every f**king time you boot the image.&lt;&#x2F;p&gt;
&lt;p&gt;I know it&#x27;s not my or thier faults, fuck the GFW and its team, but problem should be solved. I download them and mounted them as docker volume. Finally, it runs successfully!&lt;&#x2F;p&gt;
&lt;h1 id=&quot;proxies-cannot-be-used-with-advocate&quot;&gt;Proxies cannot be used with Advocate&lt;&#x2F;h1&gt;
&lt;p&gt;Everything was fine, login, admin, uploading. I upload a book and try to fetch metadata from internet, it succeed to fetch data, but failed to save the data. It shows &lt;code&gt;Error editing book: Proxies cannot be used with Advocate&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Jesus, I know I&#x27;m using a proxy, but if I don&#x27;t use a proxy, I cannot get access to Google Book, which is crucial for fetching metadata.&lt;&#x2F;p&gt;
&lt;p&gt;I searched on the internel and all I found is a github issue &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;gshang2017&#x2F;docker&#x2F;issues&#x2F;120&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;gshang2017&#x2F;docker&#x2F;issues&#x2F;120&lt;&#x2F;a&gt; which is absolutely another Chinese fired, a Chinese who faced the same problem as me.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s 4 am, my mind is blowing, I gave up.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;read-the-fucking-source-code&quot;&gt;Read the fucking source code&lt;&#x2F;h1&gt;
&lt;p&gt;The day after that day, I remembered that I can check where disable proxy usaga, at least I can write my own service that can be used with a proxy.&lt;&#x2F;p&gt;
&lt;p&gt;Then I found &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;JordanMilne&#x2F;Advocate&#x2F;blob&#x2F;74594fb8d65c20fd1bf5f2eda75619605d340533&#x2F;advocate&#x2F;adapters.py#L31&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;JordanMilne&#x2F;Advocate&#x2F;blob&#x2F;74594fb8d65c20fd1bf5f2eda75619605d340533&#x2F;advocate&#x2F;adapters.py#L31&lt;&#x2F;a&gt;. Seems that &lt;code&gt;advocate&lt;&#x2F;code&gt; just doesn&#x27;t support proxy. Maybe I can write proxy support for it? I look around and found something interesting in its &lt;code&gt;README&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;CSUwangj.github.io&#x2F;how-i-deploy-calibre-web-and-tweak-it&#x2F;.&#x2F;advocate.png&quot; alt=&quot;advocate README&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Okey, why can&#x27;t I replace it with &lt;code&gt;requests&lt;&#x2F;code&gt;? I checked&lt;code&gt;calibre-web&lt;&#x2F;code&gt; and found &lt;img src=&quot;https:&#x2F;&#x2F;CSUwangj.github.io&#x2F;how-i-deploy-calibre-web-and-tweak-it&#x2F;.&#x2F;helper.png&quot; alt=&quot;requests&quot; &#x2F;&gt;. That what I need exactly, so I wrote a small script which can help me replace &lt;code&gt;advocate&lt;&#x2F;code&gt; with &lt;code&gt;requests&lt;&#x2F;code&gt; and put it into &lt;code&gt;&#x2F;config&#x2F;custom-cont-init.d&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;#!&amp;#x2F;bin&amp;#x2F;bash

echo &amp;quot;**** patching calibre-web - removing advocate for proxy ****&amp;quot;
sed -i &amp;quot;s&amp;#x2F;import advocate&amp;#x2F;raise ImportError(\&amp;quot;no advocate\&amp;quot;)&amp;#x2F;&amp;quot; &amp;#x2F;app&amp;#x2F;calibre-web&amp;#x2F;cps&amp;#x2F;helper.py
&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Though cover uploads will failed due to absence of &lt;code&gt;advocate&lt;&#x2F;code&gt;, but check the error message, it&#x27;s at &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;janeczku&#x2F;calibre-web&#x2F;blob&#x2F;68e21e1098aab8dcbfcf024cc296bc43936bfe3c&#x2F;cps&#x2F;helper.py#L811&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;janeczku&#x2F;calibre-web&#x2F;blob&#x2F;68e21e1098aab8dcbfcf024cc296bc43936bfe3c&#x2F;cps&#x2F;helper.py#L811&lt;&#x2F;a&gt;, we can add an environment variable &lt;code&gt;CALIBRE_LOCALHOST=1&lt;&#x2F;code&gt; which solve this problem.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;i-ll-reclaim-my-lost-souls&quot;&gt;I&#x27;ll reclaim my lost souls.&lt;&#x2F;h1&gt;
&lt;p&gt;Bulk add through web interface seems amazing and complex, so it doesn&#x27;t have this feature. But remember what I&#x27;m using? It&#x27;s &lt;strong&gt;Calibre&lt;&#x2F;strong&gt;-web, it has the same library structure as Calibre.&lt;&#x2F;p&gt;
&lt;p&gt;I mounted the library folder on my laptop, open library with Calibre and add all my E-book collections into it. &lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s no better thing for both a bibliomaniac and a programmer, looking through all the books on the service I deployed.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h1&gt;
&lt;p&gt;Fuck GFW.&lt;&#x2F;p&gt;
&lt;p&gt;And always remember that source code is your best friend.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;todo&quot;&gt;TODO&lt;&#x2F;h1&gt;
&lt;p&gt;There is still some improvement to be done, but don&#x27;t know where to start, I&#x27;ll update this article as soon as I have done that.&lt;&#x2F;p&gt;
</content>
	</entry>
</feed>
